<!DOCTYPE html>
<html>
<head>
	<title>Page Title</title>
	<meta charset="utf-8"/>

	<meta name="viewport" content="width=device-width, initial-scale=1">

	<!--Apple Stuff-->
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
	<link rel="apple-touch-icon" href="/ios_ico.png">
	<!--/Apple Stuff-->

	<!--Android Stuff-->
	<link rel="manifest" href="manifest.json">
	<!--/Android Stuff-->

	<link rel="stylesheet" href="jquery.mobile-1.4.5.min.css">
	<link rel="stylesheet" href="dark.min.css">
	<script src="jquery.min.js"></script>
	<!--<script src="demos/_assets/js/index.js"></script>-->
	<script src="jquery.mobile-1.4.5.min.js"></script>

	<!--If Nothing Works enable!-->
	<!--<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.js"></script>-->
	<script src="https://www.gstatic.com/firebasejs/live/3.0/firebase.js"></script>
	<script>
	  // Initialize Firebase
	  var config = {
		apiKey: "AIzaSyBLeRUwjrRDXdVyqdXK9SBQ7jR2ZziGP8w",
		authDomain: "ceci-vertretungsplan.firebaseapp.com",
		databaseURL: "https://ceci-vertretungsplan.firebaseio.com",
		storageBucket: "ceci-vertretungsplan.appspot.com",
	  };
	  firebase.initializeApp(config);
	  var rootRef = firebase.database().ref();


	</script>
</head>
<body>

<div data-role="page">

	<div data-role="header">
		<h1>Vertretungsplan</h1>
		<!--<a href="#leftpanel1" class="ui-btn ui-shadow ui-corner-all ui-btn-inline ui-btn-mini">Overlay</a>-->
		<a href="#leftpanel1" data-role="none"><img src="nav.png" height=33 /></a>


	</div><!-- /header -->

	<div role="main" class="ui-content">
		<div id="conWarn">
		</div>

		<div id="conTable">
			<table id="table"></table>
		</div>

		<div id="conAcc">
			<h2>Login</h2>
			<p style="border: 1px solid rgba(0,0,0,.8)">In der Testphase kann es passieren, dass es ein paar Stunden dauert, bis die Daten aktualisieren!</p>
			<input type="text" id="uName" placeholder="Benutzername"></input>
			<input type="password" id="pwd"placeholder="Passwort"></input>
			<select id="dropJahrgang">
				<option selected disabled>Jahrgangsstufe</option>
				<option>ef</option>
				<option>q1</option>
				<option>q2</option>
			</select>
			<button id="subBtn" onclick="signIn('ef', false)">Login</button>

			<br />
			<h2>Fächer</h2>
			<div id="conFacher"></div>
			<input id="addFachInput" type="text" placeholder="Kurskurzel: z.B. 'E EFa'"></input>
			<button id="addFach" onclick="addFach()">Hinzufügen</button>
		</div>

		<div id="conInfo" style="display:none">
			<h2>Info</h2>
			Bei Fragen bitte an cecivplan[at]outlook.com schreiben.<br />

			Diese Webseite stellt den Vertretungsplan des Ceciliengymnasiums dar.<br />
			Der/Die Eigentümer oder der/die Verantwortliche/n von <a href="http://ceciliengymnasium.de/index.php/vertretungsplan">http://ceciliengymnasium.de/</a> sind nicht Eigentümer dieser Webseite!
			<br />
			Es ist nicht garantiert, dass die Daten dieser Seite aktuell sind. Die Daten können mittlerweile veraltet sein (siehe Zeitstempel).
			<br />

			<h3>Benutzung</h3>
			Diese Web-App ist für iOS(Apple) ausgerichtet, kann allerdings auch von jedem anderen Betriebssystem benutzt werden.<br />
			Für android installier dir bitte die App vom <a href="https://play.google.com/store/apps/details?id=com.github.leonardpieper.ceciVPlan">Google Play Store</a>.<br />
			Um die App zu installieren drücke auf den Action-Button in Safari und wähle "zum Home-Bildschirm".<br />
			Der Benutzername sowie das Passwort von <a href="http://ceciliengymnasium.de/index.php/vertretungsplan">http://ceciliengymnasium.de/</a> werden zum Anmelden benötigt.
			<br />

			<h3>Lizenz</h3>
			<i>
				Ceci Vertretungsplan<br />
				Copyright (C) 2016 Leonard Pieper<br /><br />

				Dieses Programm ist freie Software. Sie können es unter den Bedingungen der GNU General Public License, wie von der Free Software Foundation veröffentlicht, weitergeben und/oder modifizieren, entweder gemäß Version 3 der Lizenz oder (nach Ihrer Option) jeder späteren Version.<br />

				Die Veröffentlichung dieses Programms erfolgt in der Hoffnung, daß es Ihnen von Nutzen sein wird, aber OHNE IRGENDEINE GARANTIE, sogar ohne die implizite Garantie der MARKTREIFE oder der VERWENDBARKEIT FÜR EINEN BESTIMMTEN ZWECK. Details finden Sie in der GNU General Public License
			</i>
		</div>

	</div><!-- /content -->

	<div data-role="footer" data-position="fixed" data-tap-toggle="false">
		<div data-role="navbar">
			<ul>
				<li><a onclick="signIn(getStufe(), true)" ><img src='ic_person_black_24dp_1x.png'/></a></li>
				<li><a onclick="signIn('ef', false)" class="ui-btn-active" style="font-size:17px">EF</a></li>
				<li><a onclick="signIn('q1', false)" style="font-size:17px">Q1</a></li>
				<li><a onclick="signIn('q2', false)" style="font-size:17px">Q2</a></li>
			</ul>
		</div><!-- /navbar -->
	</div>

	<!-- leftpanel1  -->
	<div data-role="panel" id="leftpanel1" data-position="left" data-display="overlay" data-theme="a" class="panelBtn">

        <div class="panelHead">
		<img src="iOS_ico.png" style="height:100px"/>
			<h3>Vertretungsplan</h3>
		</div>
		<a onclick="signIn('ef', false)" class="panelBtn" data-rel="close">Vertretungsplan</a>
		<br /><hr />
		<a onclick="loginForm(); showFacher()" class="panelBtn" data-rel="close">Account</a>
		<br /><hr />
		<a onclick="info()" class="panelBtn" data-rel="close">Info</a>
        <!--<a href="#demo-links" data-rel="close" class="ui-btn ui-shadow ui-corner-all ui-btn-a ui-icon-delete ui-btn-icon-left ui-btn-inline">Close panel</a>-->

	</div><!-- /leftpanel1 -->

</div><!-- /page -->

<script type="text/javascript">
	function signIn(jahrgang, personal){

		document.getElementById("conAcc").style.display="none";
		document.getElementById("conInfo").style.display="none";

		//firebase.auth().signOut();

		var uName = document.getElementById('uName').value;
		var email= document.getElementById('uName').value + "@example.com";
        var pwd = document.getElementById('pwd').value;
		var stufe = $("#dropJahrgang :selected").text();

		if(email==null||pwd==null||email=="@example.com"||pwd==""){
			uName=localStorage.getItem("email");
			email= uName+"@example.com";
			pwd= localStorage.getItem("pwd");
			stufe = getStufe();

			if(email==null||pwd==null){
				document.getElementById('conWarn').innerHTML = "<h2>Login</h2>Bitte log dich mit deinen Zugangsdaten ein.";
			}

			document.getElementById('uName').value=uName;
			document.getElementById('pwd').value=pwd;

			$("#dropJahrgang :selected").text(stufe);

		}

		if(stufe=="Jahrgangsstufe"||stufe==""||stufe=="null"){
				alert("Bitte gib deine Jahrgangsstufe an.");
				document.getElementById('conWarn').innerHTML += "<h2> Fehler</h2>Gib deine Jahrgangsstufe an";
		}


		firebase.auth().signInWithEmailAndPassword(email, pwd).catch(function(error) {
          // Handle Errors here.
          var errorCode = error.code;
          var errorMessage = error.message;
          // [START_EXCLUDE]
          if (errorCode === 'auth/wrong-password') {
            alert('Wrong password.');
          } else {
            console.error(error);
          }
          // [END_EXCLUDE]
        });

		var auth = firebase.auth();


		if(navigator.onLine){
			auth.onAuthStateChanged(function(user) {
				if (user) {
				//alert('Geht');
				var uid = user.uid;

				if(user){
					uid = user.uid;
				}
				firebase.database().ref('users/' + uid + '/').on('value', function(snapshot) {
				var data = snapshot.val();

					var myTable = "";
					switch(jahrgang){
						case "ef":
							var stufe = data.EF;
							break;
						case "q1":
							var stufe = data.Q1;
							break;
						case "q2":
							var stufe = data.Q2;
							break;
					}

					var datum = "99.99";
					//stufe.length-1 weil das Letzte Feld das Aktualisierungsdatum ist
					for(var i=1;i<=stufe.length-2; i++){
						var obj = stufe[i];
						if(personal){
							var facher = [];
							facher = JSON.parse(localStorage.getItem("facher"));

							if(facher==null || facher.length == 0){
								myTable ="<tr><td>Füge deine Fächer unter Account hinzu!</td></tr>";
							}else{

								for(var j=0;j<facher.length;j++){
									var fach = facher[j];
									if(obj.Fach.toUpperCase() == fach.toUpperCase()){
										if(datum != obj.Datum){
											myTable+= "<tr><td colspan='3' id='date'>"+obj.Tag+"</td>";
											myTable+= "<td colspan='2' id='date'>"+obj.Datum+"</td></tr>";

											myTable+= "<tr><td class='fach'>"+obj.Fach+"</td>";
											myTable+= "<td class='stunde'>"+obj.Stunde+"</td>";
											myTable+= "<td>"+obj.Vertreter+"</td>";
											myTable+= "<td>"+obj.Raum+"</td>";
											if(isNaN(obj['Vertretungs-Text']) || obj['Vertretungs-Text'] == " " || obj['Vertretungs-Text'] == "&nbsp"){
												myTable+= "<td>"+obj['Vertretungs-Text']+"</td></tr>";
											}else{
												myTable+= "<td>&nbsp</td></tr>";
											}
										}
										else{
											myTable+= "<tr><td class='fach'>"+obj.Fach+"</td>";
											myTable+= "<td class='stunde'>"+obj.Stunde+"</td>";
											myTable+= "<td>"+obj.Vertreter+"</td>";
											myTable+= "<td>"+obj.Raum+"</td>";
											if(isNaN(obj['Vertretungs-Text']) || obj['Vertretungs-Text'] == " " || obj['Vertretungs-Text'] == "&nbsp"){
												myTable+= "<td>"+obj['Vertretungs-Text']+"</td></tr>";
											}else{
												myTable += "<td>&nbsp</td></tr>";
											}
										}
										datum = obj.Datum;
									}
								}
							}
						}else{
							if(datum != obj.Datum){
									myTable+= "<tr><td colspan='3' id='date'>"+obj.Tag+"</td>";
									myTable+= "<td colspan='2' id='date'>"+obj.Datum+"</td></tr>";

									myTable+= "<tr><td class='fach'>"+obj.Fach+"</td>";
									myTable+= "<td class='stunde'>"+obj.Stunde+"</td>";
									myTable+= "<td>"+obj.Vertreter+"</td>";
									myTable+= "<td>"+obj.Raum+"</td>";
									if(isNaN(obj['Vertretungs-Text']) || obj['Vertretungs-Text'] == " " || obj['Vertretungs-Text'] == "&nbsp"){
										myTable+= "<td>"+obj['Vertretungs-Text']+"</td></tr>";
									}else{
										myTable+= "<td>&nbsp</td></tr>";
									}
								}
								else{
									myTable+= "<tr><td class='fach'>"+obj.Fach+"</td>";
									myTable+= "<td class='stunde'>"+obj.Stunde+"</td>";
									myTable+= "<td>"+obj.Vertreter+"</td>";
									myTable+= "<td>"+obj.Raum+"</td>";
									if(isNaN(obj['Vertretungs-Text']) || obj['Vertretungs-Text'] == " " || obj['Vertretungs-Text'] == "&nbsp"){
										myTable+= "<td>"+obj['Vertretungs-Text']+"</td></tr>";
									}else{
										myTable+= "<td>&nbsp</td></tr>";
									}
								}
								datum = obj.Datum;
								datum = obj.Datum;
						}

					}


					myTable+="<tr><td id='aktStand'>"+stufe[stufe.length-1].Date+"</td></tr>";
					document.getElementById("table").innerHTML = myTable;
					document.getElementById("table").style.display="table";
					document.getElementById("conWarn").style.display="none";

					localStorage.setItem("vPlan" + jahrgang, myTable);

					setStorage();
				});

			} else {
				// User logged out
			}
			});
		//Ende Online-Mode



		}
		else{
			document.getElementById("table").innerHTML = localStorage.getItem("vPlan"+jahrgang);
		}
	}




	function showFacher(){
		var output = "Aktuelle Fächer:<ul>";
		var facher=[];
		facher=JSON.parse(localStorage.getItem("facher"));
		if(facher!=null){
			for(var i=0;i<facher.length;i++){
				var fach=facher[i];
				//output+="<li>"+fach+"<button class='delButton' onclick=removeFach("+fach+")>LÖSCHEN</button></li>";
				output+="<li>"+fach+"<button class='delButton' onclick=\"removeFach(\'"+fach+"\')\">LÖSCHEN</button></li>";
			}
		}
		output += "</ul>"
		document.getElementById("conFacher").innerHTML=output;
	}

	function addFach(){
		var facher=[];
		facher=JSON.parse(localStorage.getItem("facher"));

		if(facher==null){
			facher=[document.getElementById('addFachInput').value];
		}else{
			facher.push(document.getElementById('addFachInput').value);
		}
		localStorage.setItem("facher", JSON.stringify(facher));
		showFacher();

	}

	function removeFach(kurs){
		var facher=[];
		facher=JSON.parse(localStorage.getItem("facher"));
		if(facher!=null){
			for(var i=0;i<facher.length;i++){
				var fach=facher[i];
				if(fach==kurs){
					facher.splice(i, 1);
					localStorage.setItem("facher", JSON.stringify(facher));
				}
			}
		}
		showFacher();
	}

	function loginForm(){
		document.getElementById("conAcc").style.display="block";
		document.getElementById("table").style.display="none";
		document.getElementById("conInfo").style.display="none";
	}

	function setStorage(){
		localStorage.setItem("email", document.getElementById('uName').value);
		localStorage.setItem("pwd", document.getElementById('pwd').value);

		if($("#dropJahrgang :selected").text()=="Jahrgangsstufe"){
		}else{
		localStorage.setItem("stufe", $("#dropJahrgang :selected").text());
		}
	}

	function getStufe(){
		stufe=localStorage.getItem("stufe");
		return stufe;
	}

	function disableFirst(){
		localStorage.setItem("first", "first");
		document.getElementById("first").style.display="none";
	}

	function info(){
		document.getElementById("table").style.display="none";
		document.getElementById("conAcc").style.display="none";
		document.getElementById("conInfo").style.display="block";
	}

	$(document).ready(function(){
		//Apple Cache Stuff
		//if (window.applicationCache.status == window.applicationCache.UPDATEREADY){
		//	window.applicationCache.update();
		//	window.applicationCache.swapCache();
		//}


		//first Start:
		var first=localStorage.getItem("first");
		if(window.navigator.standalone == true) {
		}else{
			if(first != "first"){
				document.getElementById("conAcc").style.display="none";
				var iOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
				//if(iOS){
					document.getElementById("conTable").innerHTML += "<div id='first'><h2>App installieren: </h2>Bitte installiere diese App mit Klick auf <img src='action-icon-ios7.png' height='20'/> und dann \'Zum Home-Bildschirm\'<br /> <a onclick='disableFirst()'>Ich möchte diese Nachricht nicht mehr sehen</a></div";
				//}
			}
		}


		signIn("ef");
		});




	</script>

</body>
</html>
